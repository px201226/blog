<!DOCTYPE html>
<html lang="ko-KR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Cloud AWS Messaging 모듈 문제점 및 튜닝 | 끄적끄적 개발일지</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script src="https://www.googletagmanager.com/gtag/js?id=G-SE0BLFFFMG"></script>
    <meta name="description" content="Awesome description">
    
    <link rel="preload" href="/assets/css/0.styles.4bffb705.css" as="style"><link rel="preload" href="/assets/js/app.70752fd1.js" as="script"><link rel="preload" href="/assets/js/17.4dcf5890.js" as="script"><link rel="preload" href="/assets/js/5.6b61195e.js" as="script"><link rel="prefetch" href="/assets/js/10.1fe66b22.js"><link rel="prefetch" href="/assets/js/11.3e8e6dd5.js"><link rel="prefetch" href="/assets/js/12.96743d99.js"><link rel="prefetch" href="/assets/js/13.5cab9bdd.js"><link rel="prefetch" href="/assets/js/14.e412fb10.js"><link rel="prefetch" href="/assets/js/15.1da5e3dc.js"><link rel="prefetch" href="/assets/js/16.8ebbd2f8.js"><link rel="prefetch" href="/assets/js/18.5bfa6a85.js"><link rel="prefetch" href="/assets/js/19.12bd999a.js"><link rel="prefetch" href="/assets/js/2.0c177ed1.js"><link rel="prefetch" href="/assets/js/20.87648ee0.js"><link rel="prefetch" href="/assets/js/21.7fbb071c.js"><link rel="prefetch" href="/assets/js/22.3f3676f6.js"><link rel="prefetch" href="/assets/js/23.114b4211.js"><link rel="prefetch" href="/assets/js/24.7077956a.js"><link rel="prefetch" href="/assets/js/25.42ad01f0.js"><link rel="prefetch" href="/assets/js/26.c356a4d4.js"><link rel="prefetch" href="/assets/js/27.52a125bd.js"><link rel="prefetch" href="/assets/js/28.692ecc68.js"><link rel="prefetch" href="/assets/js/29.d205c4cb.js"><link rel="prefetch" href="/assets/js/3.6ee8ed88.js"><link rel="prefetch" href="/assets/js/30.c221f26d.js"><link rel="prefetch" href="/assets/js/31.65e9c8ce.js"><link rel="prefetch" href="/assets/js/32.7ddfb0f5.js"><link rel="prefetch" href="/assets/js/33.7f74862d.js"><link rel="prefetch" href="/assets/js/34.21b19958.js"><link rel="prefetch" href="/assets/js/35.428cdea5.js"><link rel="prefetch" href="/assets/js/36.ef46a37e.js"><link rel="prefetch" href="/assets/js/37.290a8b87.js"><link rel="prefetch" href="/assets/js/38.61002123.js"><link rel="prefetch" href="/assets/js/39.fbbd1cce.js"><link rel="prefetch" href="/assets/js/4.39bb3471.js"><link rel="prefetch" href="/assets/js/40.ee500a11.js"><link rel="prefetch" href="/assets/js/41.ce50acc7.js"><link rel="prefetch" href="/assets/js/42.b0e56f29.js"><link rel="prefetch" href="/assets/js/43.c4683cd4.js"><link rel="prefetch" href="/assets/js/44.4fd9959c.js"><link rel="prefetch" href="/assets/js/45.10201422.js"><link rel="prefetch" href="/assets/js/6.d4a6ae6d.js"><link rel="prefetch" href="/assets/js/7.8da69c67.js"><link rel="prefetch" href="/assets/js/8.8044f9c2.js"><link rel="prefetch" href="/assets/js/9.8e23472b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4bffb705.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="v-application v-application--is-ltr theme--light" style="background:#F3F5F7;"><div class="v-application--wrap"><div class="container pa-0" style="max-width:900px;"><link href="https://fonts.googleapis.com/css?family=Jura" rel="stylesheet"> <div class="text-center py-8 v-toolbar__title v-app-bar-title" style="font-family:'Jura';"><div class="v-app-bar-title__content"><h1 class="primary--text">끄적끄적 개발일지</h1></div><div class="v-app-bar-title__placeholder" style="visibility:visible;"><h1 class="primary--text">끄적끄적 개발일지</h1></div></div> <div role="list" class="v-list pa-0 v-sheet theme--light v-list--flat transparent"><div role="listbox" class="v-item-group theme--light v-list-item-group indigo--text"><div class="row mb-0 text-center no-gutters justify-center"><div class="col-lg-2 col"><a href="/" tabindex="0" block="" text="" role="option" aria-selected="false" class="py-2  v-list-item v-list-item--link theme--light primary--text"><div class="v-list-item__title">Home</div></a></div> <div class="col-lg-2 col"><a href="/category" aria-current="page" tabindex="0" block="" text="" role="option" aria-selected="false" class="py-2 v-item--active v-list-item--active v-list-item v-list-item--link theme--light primary--text"><div class="v-list-item__title">Category</div></a></div> <div class="col-lg-2 col"><a href="/profiles" tabindex="0" block="" text="" role="option" aria-selected="false" class="py-2 v-list-item v-list-item--link theme--light primary--text"><div class="v-list-item__title">Profiles</div></a></div></div></div></div> <hr role="separator" aria-orientation="horizontal" class="mb-3 v-divider theme--light"> <div><div data-v-52bca676><div class="px-0 col col-12" data-v-52bca676 data-v-52bca676><div class="pa-5 px-md-7 v-card v-sheet theme--light elevation-1" data-v-52bca676><div data-v-52bca676><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html" aria-current="page" class="text-h4 font-weight-bold router-link-exact-active router-link-active" data-v-52bca676><div data-v-52bca676><!----></div>
          Spring Cloud AWS Messaging 모듈 문제점 및 튜닝
        </a> <br data-v-52bca676> <span class="text-caption grey--text text--darken-1 " data-v-52bca676>2023-06-20 &gt; AWS
        </span></div> <hr role="separator" aria-orientation="horizontal" class="mt-4 mb-4 v-divider theme--light" data-v-52bca676> <div class="theme-container" data-v-52bca676><div class="toc" data-v-52bca676><ul><li><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html#_1-simplemessagelistenercontainer">1. SimpleMessageListenerContainer</a></li><li><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html#_2-simplemessagelistenercontainer-의-문제">2. SimpleMessageListenerContainer 의 문제</a><ul><li><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html#낮은-처리량-문제">낮은 처리량 문제</a></li><li><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html#단일-payload-handling">단일 Payload Handling</a></li></ul></li><li><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html#_1-처리량-극복">1. 처리량 극복</a></li><li><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html#_2-단일-페이로드-극복">2. 단일 페이로드 극복</a></li><li><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html#_1-eventworkpool-설정">1. EventWorkPool 설정</a></li><li><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html#_2-sqsmessagehandler-구현">2. SqsMessageHandler 구현</a></li><li><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html#_3-messagedispatcher-구현">3. MessageDispatcher 구현</a></li><li><a href="/category/aws/Spring%20Cloud%20AWS%20Messaging%20Module%20Best%20Practice.html#_4-사용">4. 사용</a></li></ul></div> <div class="theme-default-content custom post markdown-body content__default" data-v-52bca676><h1 id="_1-개요"><a href="#_1-개요" class="header-anchor">#</a> <strong>1. 개요</strong></h1> <ul><li>일반적으로 Spring 환경에서 Amazon SQS 라이브러리로 <code>spring-cloud-aws-messaging</code> 모듈을 사용합니다.</li> <li><code>spring-cloud-aws-messaging</code> 을 분석하고, 단점을 보완한 모듈을 설계하는 것을 목표로 합니다.</li></ul> <h1 id="_2-spring-cloud-aws-messaging-모듈"><a href="#_2-spring-cloud-aws-messaging-모듈" class="header-anchor">#</a> <strong>2. Spring Cloud AWS Messaging 모듈</strong></h1> <ul><li><code>spring-cloud-aws-messaging</code> 모듈을 사용하면 <code>Amazon SQS SDK</code>를 추상화한 API를 사용해 쉽게 <code>Producer</code>와 <code>Consumer</code>를 구현할 수 있습니다.</li> <li>아래와 같이 간단한 설정만으로 Consumer의 경우 Polling Thread Pool을 자동으로 만들어주고, <code>@SqsListener</code> 어노테이션을 통해 특정 큐를 구독하여 메시지를 처리할 수 있습니다.</li></ul> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code># build<span class="token punctuation">.</span>gradle
dependencies <span class="token punctuation">{</span>
    implementation <span class="token string">'org.springframework.cloud:spring-cloud-aws-autoconfigure:2.2.1.RELEASE'</span>
    implementation <span class="token string">'org.springframework.cloud:spring-cloud-aws-messaging:2.2.1.RELEASE'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqsConfig</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AWSCredentialsProvider</span> awsCredentialsProvider<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${cloud.aws.region.static}&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">String</span> region<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@Primary</span>
	<span class="token keyword">public</span> <span class="token class-name">AmazonSQSAsync</span> <span class="token function">amazonSQSAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token class-name">AmazonSQSAsyncClientBuilder</span><span class="token punctuation">.</span><span class="token function">standard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withCredentials</span><span class="token punctuation">(</span>awsCredentialsProvider<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">withRegion</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* Consumer 설정 클래스
*/</span>
<span class="token annotation punctuation">@Configration</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqsConsumeConfig</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AmazonSQSAsync</span> amazonSQSAsync<span class="token punctuation">;</span>

    <span class="token comment">/**
    *  Consumer 에서 SQS Queue로 폴링하는 컨테이너를 설정합니다.
    **/</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">SimpleMessageListenerContainerFactory</span> <span class="token function">simpleMessageListenerContainerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">final</span> <span class="token class-name">SimpleMessageListenerContainerFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleMessageListenerContainerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		factory<span class="token punctuation">.</span><span class="token function">setAmazonSqs</span><span class="token punctuation">(</span>amazonSQSAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setMaxNumberOfMessages</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setWaitTimeOut</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setBackOffTime</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> factory<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>SQS 큐를 Polling 하는 핵심 매커니즘을 <code>SimpleMessageListenerContainer</code>를 정의할 수 있습니다.</p> <ul><li><strong>WaitTimeOut</strong> :- 현재 대기열에 메시지가 없는 경우 폴링 요청이 새 메시지가 도착할 때까지 기다리는 대기 시간 제한을 구성합니다. 값이 높을수록 시스템에 대한 폴링 요청이 크게 줄어듭니다.</li> <li><strong>MaxNumberOfMessage :</strong> Amazon SQS 시스템에 대한 한 번의 폴링 중에 검색해야 하는 최대 메시지 수를 구성합니다. 최대 메시지 수(1–10)</li> <li><strong>BackOffTime:-</strong> 폴링 스레드가 오류 발생 시 복구를 시도하기 전에 대기해야 하는 밀리초 수입니다. 이렇게 하면 작업자가 용량을 초과하는 요청에 압도당하는 것을 방지할 수 있습니다.</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqsMessageListener</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
    * 폴링 스레드에서 핸들링한 메시지가 @SqsListener 로 넘어옵니다.
    **/</span>
	<span class="token annotation punctuation">@SqsListener</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;QueueName&quot;</span><span class="token punctuation">,</span> deletionPolicy <span class="token operator">=</span> <span class="token class-name">SqsMessageDeletionPolicy</span><span class="token punctuation">.</span>NEVER<span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">ApplicationEventMessage</span> message<span class="token punctuation">,</span> <span class="token class-name">MessageHeaders</span> messageHeaders<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> acknowledgment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot; received Message from SQS queue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* Producer 설정 클래스
*/</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqsPublishConfig</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AmazonSQSAsync</span> amazonSQSAsync<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> objectMapper<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">QueueMessagingTemplate</span> <span class="token function">queueMessagingTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">QueueMessagingTemplate</span><span class="token punctuation">(</span>amazonSQSAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">StringHttpMessageConverter</span> <span class="token function">stringHttpMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringHttpMessageConverter</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FooService</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">QueueMessagingTemplate</span> queueMessagingTemplate<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publih</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">queueMessageTemplate</span><span class="token punctuation">(</span><span class="token string">&quot;queueName&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_1-simplemessagelistenercontainer"><a href="#_1-simplemessagelistenercontainer" class="header-anchor">#</a> <strong>1. SimpleMessageListenerContainer</strong></h2> <ul><li><code>spring-cloud-aws-messaging</code> 모듈을 사용하면 <code>SimpleMessageListenerContainer</code> 라는 클래스가 SQS 큐에서 메시지를 폴링하여 <code>@SqsHandler</code> 에게 넘깁니다.</li> <li><code>SimpleMessageListenerContainer</code> 는 Polling 을 위한 스레드풀을 별도로 생성하여 동작합니다.</li> <li>Polling 스레드풀의 스레드 갯수는 아래 공식으로 결정됩니다.
<ul><li><strong>등록된 큐의 개수 * ( 폴링 시 한번에 받을 수 있는 최대 메시지 수 + 1)</strong> <ul><li>ex) 등록된 큐의 개수가 1개이고, 폴링 시 한번에 받을 수 있는 최대 메시지 수가 10개이면 <code>1 * (10 + 1) = 11개</code>의 폴링 스레드가 생성됩니다.</li></ul></li></ul></li></ul> <p><img src="/assets/img/Untitled.00da5f86.png" alt="Untitled"></p> <h2 id="_2-simplemessagelistenercontainer-의-문제"><a href="#_2-simplemessagelistenercontainer-의-문제" class="header-anchor">#</a> <strong>2. SimpleMessageListenerContainer 의 문제</strong></h2> <p><img src="/assets/img/Untitled_1.d7902636.png" alt="Untitled"></p> <ul><li><code>SimpleMessageListnerContainer</code> 가 동작되는 방식은 아래 코드를 보면 알 수 있습니다.</li> <li>1번 : <code>AmazonSQS Client</code>를 통해 큐로 <code>Polling Request</code>를 전송하여 메시지를 응답 받습니다.</li> <li>2번 : 응답받은 메시지 수 만큼 <code>CountDownLatch</code> 객체를 생성합니다.</li> <li>3번 : 응답받은 각 메시지를 For문으로 돌면서 할당받은 스레드풀에 작업을 등록합니다.
<ul><li>스레드풀에 전달하는 <code>SignalExecutingRunnable</code>객체는 각 메시지가 처리되면 <code>CountDownLatch</code> 값을 Down 시킵니다.</li></ul></li> <li>5번 : <code>CountDownLatch</code> 가 0이 될때 까지 대기합니다.</li></ul> <h3 id="낮은-처리량-문제"><a href="#낮은-처리량-문제" class="header-anchor">#</a> 낮은 처리량 문제</h3> <p><code>SimpleMessageContainerListener</code> 의 구현에서의 문제점은 최대 10개 메시지를 수신하여 처리할 수 있고, 이 메시지 모두가 처리되면 다음 <code>Poilling</code> 을 시작합니다.  대부분의 스레드가 DB Blocking I/O 작업으로 인해 비효율적인 CPU 사용을 초래할 수 있고, 10개 메시지 중에 처리가 오래걸리는 메시지가 존재한다면 그 메시지가 처리될 때까지 다른  모든 스레드가 대기하게 되므로 Consumer의 처리량이 낮아지게 됩니다.</p> <h3 id="단일-payload-handling"><a href="#단일-payload-handling" class="header-anchor">#</a> 단일 Payload Handling</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
	<span class="token annotation punctuation">@SqsListener</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;async_ff.fifo&quot;</span><span class="token punctuation">,</span> deletionPolicy <span class="token operator">=</span> <span class="token class-name">SqsMessageDeletionPolicy</span><span class="token punctuation">.</span>NEVER<span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">ApplicationEventMessage</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;receieved Message {} &quot;</span> <span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@SqsListener</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;async_ff.fifo&quot;</span><span class="token punctuation">,</span> deletionPolicy <span class="token operator">=</span> <span class="token class-name">SqsMessageDeletionPolicy</span><span class="token punctuation">.</span>NEVER<span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">MessageHeaders</span> messageHeaders<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> acknowledgment<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;receieved Message {} &quot;</span> <span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li><code>async_ff.fifo</code> 큐에 대해서 <code>@SqsListener</code>로 메시지를 구독합니다.</li> <li>첫번쨰 핸들러의 페이로드 타입은 <code>ApplicationEventMessage</code> 이고, 두번째 핸들러 페이로드 타입은 <code>Message</code>입니다.</li> <li>위 코드를 돌려보면 아래와 같이 async_ff_fifo 큐에 중복된 핸들러로 맵핑할 수 없는 예외가 발생합니다.</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>Ambiguous handler methods mapped for destination 'async_ff.fifo': {public void com.example.awssqspilot.springboot.listener.SqsMessageListener.handle1(com.example.awssqspilot.domain.model.ApplicationEventMessage,org.springframework.messaging.MessageHeaders,org.springframework.cloud.aws.messaging.listener.Acknowledgment) throws java.lang.InterruptedException, public void com.example.awssqspilot.springboot.listener.SqsMessageListener.handle2(org.springframework.messaging.Message,org.springframework.messaging.MessageHeaders,org.springframework.cloud.aws.messaging.listener.Acknowledgment) throws java.lang.InterruptedException}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h1 id="_3-solution"><a href="#_3-solution" class="header-anchor">#</a> <strong>3. Solution</strong></h1> <h2 id="_1-처리량-극복"><a href="#_1-처리량-극복" class="header-anchor">#</a> <strong>1. 처리량 극복</strong></h2> <p><img src="/assets/img/Untitled_2.1294f674.png" alt="Untitled"></p> <ul><li>폴링 스레드에서 메시지를 처리하는 것이 아니라 <code>MessageHandler</code>로 메시지 처리를 위임합니다.</li> <li>폴링 스레드는 <code>MessageHandler</code> 에 작업만 전달하고 결과를 기다리지 않고, SQS Queue 로 다음 폴링 요청만 받습니다.</li> <li>MessageHandler는 <code>EventWorkThreadPool</code>을 구성하고, 비동기처리로 CPU burst time 을 높입니다.</li></ul> <h2 id="_2-단일-페이로드-극복"><a href="#_2-단일-페이로드-극복" class="header-anchor">#</a> <strong>2. 단일 페이로드 극복</strong></h2> <p><img src="/assets/img/Untitled_3.8ccfce15.png" alt="Untitled"></p> <h1 id="_4-implementation"><a href="#_4-implementation" class="header-anchor">#</a> <strong>4. Implementation</strong></h1> <h2 id="_1-eventworkpool-설정"><a href="#_1-eventworkpool-설정" class="header-anchor">#</a> <strong>1. EventWorkPool 설정</strong></h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;eventWorkerPool&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ThreadPoolTaskExecutor</span> <span class="token function">eventWorkerPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">ThreadPoolTaskExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	executor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 스레드풀 개수를 설정합니다.</span>
	executor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 스레드풀 대기큐에 과도한 요청이 들어오는걸 방지하기 위해 대기큐 사이즈를 0으로 설정합니다.</span>
	<span class="token keyword">return</span> executor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_2-sqsmessagehandler-구현"><a href="#_2-sqsmessagehandler-구현" class="header-anchor">#</a> <strong>2. SqsMessageHandler 구현</strong></h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqsMessageHandler</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AsyncTaskExecutor</span> eventWorkerPool<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MessageTypeDispatcher</span> messageTypeDispatcher<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> backOffTime <span class="token operator">=</span> <span class="token number">5000L</span><span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span>
			<span class="token keyword">final</span> <span class="token class-name">SqsMessage</span> message<span class="token punctuation">,</span>
			<span class="token keyword">final</span> <span class="token class-name">MessageHeaders</span> messageHeaders<span class="token punctuation">,</span>
			<span class="token keyword">final</span> <span class="token class-name">Acknowledgment</span> acknowledgment
	<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>

			eventWorkerPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

				<span class="token keyword">try</span> <span class="token punctuation">{</span>
					<span class="token keyword">final</span> <span class="token class-name">Object</span> result <span class="token operator">=</span> messageTypeDispatcher<span class="token punctuation">.</span><span class="token function">doDispatch</span><span class="token punctuation">(</span><span class="token function">getMessageType</span><span class="token punctuation">(</span>messageHeaders<span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

					log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;EventWorkerPool Exception occurred&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">try</span> <span class="token punctuation">{</span>
						<span class="token comment">// noinspection BusyWait</span>
						<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>backOffTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>

					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;eventThreadPool Queue is full. {}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> e<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token class-name">MessageType</span> <span class="token function">getMessageType</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MessageHeaders</span> messageHeaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MessageType</span><span class="token punctuation">(</span>messageHeaders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">SqsMessageHeaders</span><span class="token punctuation">.</span>SQS_EVENT_TYPE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h2 id="_3-messagedispatcher-구현"><a href="#_3-messagedispatcher-구현" class="header-anchor">#</a> <strong>3. MessageDispatcher 구현</strong></h2> <p><img src="/assets/img/Untitled_4.2cf93942.png" alt="Untitled"></p> <ul><li>JAVA Reflection 과 Spring Component 스캔을 이용해서 <code>dynamic dispatch</code>로 구현</li></ul> <ol><li><code>processor</code> 객체로 <code>messageType</code> 에 해당하는 <code>advice</code> 객체를 <code>get</code> 합니다.</li> <li>반환받은 advice 객체 정보를 이용해서 <code>target bean</code> 과 <code>method</code>를 가져옵니다.</li> <li><code>target method</code> 파라미터 타입에 맞게 ObjectMapper로 <code>json -&gt; Object</code> 로 맵핑 후, <code>target method</code> 를 실행합니다.</li></ol> <h2 id="_4-사용"><a href="#_4-사용" class="header-anchor">#</a> 4. 사용</h2> <p><img src="/assets/img/Untitled_5.4956f16a.png" alt="Untitled"></p></div></div></div></div> <div data-v-52bca676></div></div></div></div> <footer prime="" class="v-footer mt-2 v-sheet theme--light v-footer--padless" style="background:#F3F5F7;"><div class="col col-12"><div class="text-center v-card v-card--flat v-sheet theme--light rounded-0" style="background:#F3F5F7;"><div class="v-card__text"><p>Copyright © 2021 All Right <em>끄적끄적 개발일지</em></p> <p>
          px201226@gmail.com .
          <a href="https://github.com/px201226" target="_blank">GitHub</a>
          .
          <a href="http://px201226.github.io/blog" target="_blank">Blog</a>
          .
        </p></div></div></div></footer></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.70752fd1.js" defer></script><script src="/assets/js/17.4dcf5890.js" defer></script><script src="/assets/js/5.6b61195e.js" defer></script>
  </body>
</html>
